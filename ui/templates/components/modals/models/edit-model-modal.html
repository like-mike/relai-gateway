<!-- Edit Model Modal -->
<div id="edit-model-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-out" role="dialog" aria-modal="true" aria-labelledby="edit-model-title" aria-describedby="edit-model-description">
  <!-- Modal Container -->
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto transform transition-all duration-300 ease-out scale-95 opacity-0" id="edit-model-container">
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 id="edit-model-title" class="text-xl font-bold text-gray-900">Edit Model</h2>
      <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg p-1" onclick="closeEditModelModal()" aria-label="Close modal">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6" id="edit-model-description">
      <form id="edit-model-form">
        <input type="hidden" id="edit-model-id" name="id">
        
        <!-- Model Name -->
        <div class="mb-4">
          <label for="edit-model-name" class="block text-sm font-medium text-gray-700 mb-2">Model Name <span class="text-red-500">*</span></label>
          <input type="text" id="edit-model-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="Enter model name">
        </div>

        <!-- Model Description -->
        <div class="mb-4">
          <label for="edit-model-description-field" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="edit-model-description-field" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="Enter model description"></textarea>
        </div>

        <!-- Provider -->
        <div class="mb-4">
          <label for="edit-model-provider" class="block text-sm font-medium text-gray-700 mb-2">Provider <span class="text-red-500">*</span></label>
          <select id="edit-model-provider" name="provider" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            <option value="">Select provider</option>
            <option value="openai">OpenAI</option>
            <!-- <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
            <option value="azure">Azure OpenAI</option>
            <option value="aws">AWS Bedrock</option>
            <option value="huggingface">Hugging Face</option>
            <option value="custom">Custom</option> -->
          </select>
        </div>

        <!-- Model Configuration -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">Model Configuration</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- API Endpoint -->
            <div>
              <label for="edit-model-endpoint" class="block text-sm font-medium text-gray-600 mb-2">API Endpoint</label>
              <input type="url" id="edit-model-endpoint" name="api_endpoint" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="https://api.example.com/v1">
            </div>

            <!-- API Token -->
            <div>
              <label for="edit-model-token" class="block text-sm font-medium text-gray-600 mb-2">API Token</label>
              <input type="password" id="edit-model-token" name="api_token" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="your-api-token">
            </div>

            <!-- Model ID -->
            <div>
              <label for="edit-model-id-field" class="block text-sm font-medium text-gray-600 mb-2">Model ID</label>
              <input type="text" id="edit-model-id-field" name="model_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="gpt-4">
            </div>

            <!-- Input Cost per 1M tokens -->
            <div>
              <label for="edit-model-input-cost" class="block text-sm font-medium text-gray-600 mb-2">
                Input Cost per 1M Tokens (USD)
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">$</span>
                <input type="number" id="edit-model-input-cost" name="input_cost_per_1m"
                       step="0.01" min="0" max="1000000"
                       class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
              </div>
              <p class="text-xs text-gray-500 mt-1">Cost for 1 million input/prompt tokens</p>
            </div>

            <!-- Output Cost per 1M tokens -->
            <div>
              <label for="edit-model-output-cost" class="block text-sm font-medium text-gray-600 mb-2">
                Output Cost per 1M Tokens (USD)
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">$</span>
                <input type="number" id="edit-model-output-cost" name="output_cost_per_1m"
                       step="0.01" min="0" max="1000000"
                       class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
              </div>
              <p class="text-xs text-gray-500 mt-1">Cost for 1 million output/completion tokens</p>
            </div>
          </div>
        </div>

        <!-- Advanced Settings -->
        <div class="mb-6">
          <button type="button" onclick="toggleEditAdvancedSettings()" class="flex items-center text-sm font-medium text-gray-700 hover:text-gray-900">
            <svg id="edit-advanced-chevron" class="w-4 h-4 mr-2 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            Advanced Settings
          </button>
          <div id="edit-advanced-settings" class="hidden mt-4 space-y-4">
            <!-- Rate Limiting -->
            <div>
              <label for="edit-model-rate-limit" class="block text-sm font-medium text-gray-600 mb-2">Rate Limit (requests/minute)</label>
              <input type="number" id="edit-model-rate-limit" name="rate_limit" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="100">
            </div>

            <!-- Custom Headers -->
            <div>
              <label for="edit-model-headers" class="block text-sm font-medium text-gray-600 mb-2">Custom Headers (JSON)</label>
              <textarea id="edit-model-headers" name="headers" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder='{"Authorization": "Bearer token"}'></textarea>
            </div>

            <!-- Retry & Timeout Configuration -->
            <div class="border-t border-gray-200 pt-4 mt-4">
              <h5 class="text-sm font-medium text-gray-700 mb-3">Reliability Configuration</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Max Retries -->
                <div>
                  <label for="edit-model-max-retries" class="block text-sm font-medium text-gray-600 mb-2">
                    Max Retries
                    <span class="text-gray-400 font-normal">(Default: 2)</span>
                  </label>
                  <input type="number" id="edit-model-max-retries" name="max_retries" min="0" max="3"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="2" onchange="updateRetryPreview('edit')">
                  <p class="text-xs text-gray-500 mt-1">Number of retry attempts on failure (0-3)</p>
                </div>

                <!-- Timeout -->
                <div>
                  <label for="edit-model-timeout-seconds" class="block text-sm font-medium text-gray-600 mb-2">
                    Timeout (seconds)
                    <span class="text-gray-400 font-normal">(Default: 30)</span>
                  </label>
                  <input type="number" id="edit-model-timeout-seconds" name="timeout_seconds" min="5" max="300"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="30">
                  <p class="text-xs text-gray-500 mt-1">Request timeout in seconds (5-300, max 5 minutes)</p>
                </div>

                <!-- Retry Delay -->
                <div>
                  <label for="edit-model-retry-delay" class="block text-sm font-medium text-gray-600 mb-2">
                    Initial Retry Delay (ms)
                    <span class="text-gray-400 font-normal">(Default: 1000)</span>
                  </label>
                  <input type="number" id="edit-model-retry-delay" name="retry_delay_ms" min="100" max="10000" step="100"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="1000" onchange="updateRetryPreview('edit')">
                  <p class="text-xs text-gray-500 mt-1">Initial delay before retry (100-10000ms)</p>
                </div>

                <!-- Backoff Multiplier -->
                <div>
                  <label for="edit-model-backoff-multiplier" class="block text-sm font-medium text-gray-600 mb-2">
                    Backoff Multiplier
                    <span class="text-gray-400 font-normal">(Default: 2.0)</span>
                  </label>
                  <input type="number" id="edit-model-backoff-multiplier" name="backoff_multiplier" min="1.0" max="5.0" step="0.1"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="2.0" onchange="updateRetryPreview('edit')">
                  <p class="text-xs text-gray-500 mt-1">Exponential backoff multiplier (1.0-5.0)</p>
                </div>
              </div>

              <!-- Retry Strategy Preview -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <h6 class="text-sm font-medium text-gray-700 mb-2">Retry Strategy Preview:</h6>
                <div id="edit-retry-preview" class="text-xs text-gray-600">
                  Attempt 1: 0ms → Attempt 2: 1000ms → Attempt 3: 2000ms
                </div>
              </div>
            </div>

            <!-- Active Status -->
            <div>
              <label class="flex items-center">
                <input type="checkbox" id="edit-model-active" name="active" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-700">Active (enable this model for use)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Error Message Container -->
        <div id="edit-model-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-600" id="edit-model-error-message"></p>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200">
      <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="closeEditModelModal()">Cancel</button>
      <button type="submit" form="edit-model-form" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Save Changes</button>
    </div>
  </div>
</div>

<script>
// Edit model modal functionality
let editModelLastFocusedElement = null;
let editModelFocusableElements = [];
let currentEditingModel = null;

function openEditModelModal(model) {
  // Store the model and currently focused element
  currentEditingModel = model;
  editModelLastFocusedElement = document.activeElement;
  
  const modal = document.getElementById('edit-model-modal');
  const modalContainer = document.getElementById('edit-model-container');
  
  // Populate form with model data
  populateEditModelForm(model);
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Trigger animations
  setTimeout(() => {
    modal.classList.add('opacity-100');
    modalContainer.classList.remove('scale-95', 'opacity-0');
    modalContainer.classList.add('scale-100', 'opacity-100');
  }, 10);
  
  // Set up focus trapping
  setupEditModelFocusTrap();
  
  // Focus the first input
  setTimeout(() => {
    document.getElementById('edit-model-name').focus();
  }, 100);
  
  // Add event listeners
  document.addEventListener('keydown', handleEditModelKeyDown);
  modal.addEventListener('click', handleEditModelOverlayClick);
}

function populateEditModelForm(model) {
  document.getElementById('edit-model-id').value = model.id;
  document.getElementById('edit-model-name').value = model.name || '';
  document.getElementById('edit-model-description-field').value = model.description || '';
  document.getElementById('edit-model-provider').value = model.provider || '';
  document.getElementById('edit-model-endpoint').value = model.api_endpoint || '';
  document.getElementById('edit-model-token').value = model.api_token || '';
  document.getElementById('edit-model-id-field').value = model.model_id || '';
  document.getElementById('edit-model-input-cost').value = model.input_cost_per_1m || '';
  document.getElementById('edit-model-output-cost').value = model.output_cost_per_1m || '';
  document.getElementById('edit-model-rate-limit').value = model.rate_limit || '';
  document.getElementById('edit-model-headers').value = model.headers || '';
  
  // New retry/timeout fields
  document.getElementById('edit-model-max-retries').value = model.max_retries || '';
  document.getElementById('edit-model-timeout-seconds').value = model.timeout_seconds || '';
  document.getElementById('edit-model-retry-delay').value = model.retry_delay_ms || '';
  document.getElementById('edit-model-backoff-multiplier').value = model.backoff_multiplier || '';
  
  document.getElementById('edit-model-active').checked = model.active || false;
  
  // Update retry preview after populating values
  updateRetryPreview('edit');
}

function closeEditModelModal() {
  const modal = document.getElementById('edit-model-modal');
  const modalContainer = document.getElementById('edit-model-container');
  
  // Trigger close animations
  modal.classList.remove('opacity-100');
  modalContainer.classList.remove('scale-100', 'opacity-100');
  modalContainer.classList.add('scale-95', 'opacity-0');
  
  // Hide modal after animation
  setTimeout(() => {
    modal.classList.add('hidden');
    
    // Reset form
    document.getElementById('edit-model-form').reset();
    hideEditModelError();
    
    // Reset advanced settings
    document.getElementById('edit-advanced-settings').classList.add('hidden');
    document.getElementById('edit-advanced-chevron').style.transform = 'rotate(0deg)';
    
    // Reset state
    currentEditingModel = null;
    
    // Restore focus
    if (editModelLastFocusedElement) {
      editModelLastFocusedElement.focus();
    }
  }, 300);
  
  // Remove event listeners
  document.removeEventListener('keydown', handleEditModelKeyDown);
  modal.removeEventListener('click', handleEditModelOverlayClick);
}

function setupEditModelFocusTrap() {
  const modal = document.getElementById('edit-model-container');
  editModelFocusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
}

function handleEditModelKeyDown(event) {
  if (event.key === 'Escape') {
    closeEditModelModal();
    return;
  }
  
  if (event.key === 'Tab') {
    trapEditModelFocus(event);
  }
}

function trapEditModelFocus(event) {
  const firstFocusable = editModelFocusableElements[0];
  const lastFocusable = editModelFocusableElements[editModelFocusableElements.length - 1];
  
  if (event.shiftKey) {
    // Shift + Tab
    if (document.activeElement === firstFocusable) {
      event.preventDefault();
      lastFocusable.focus();
    }
  } else {
    // Tab
    if (document.activeElement === lastFocusable) {
      event.preventDefault();
      firstFocusable.focus();
    }
  }
}

function handleEditModelOverlayClick(event) {
  if (event.target === event.currentTarget) {
    closeEditModelModal();
  }
}

function toggleEditAdvancedSettings() {
  const settings = document.getElementById('edit-advanced-settings');
  const chevron = document.getElementById('edit-advanced-chevron');
  
  if (settings.classList.contains('hidden')) {
    settings.classList.remove('hidden');
    chevron.style.transform = 'rotate(90deg)';
  } else {
    settings.classList.add('hidden');
    chevron.style.transform = 'rotate(0deg)';
  }
}

function showEditModelError(message) {
  const errorContainer = document.getElementById('edit-model-error');
  const errorMessage = document.getElementById('edit-model-error-message');
  
  errorMessage.textContent = message;
  errorContainer.classList.remove('hidden');
}

function hideEditModelError() {
  const errorContainer = document.getElementById('edit-model-error');
  errorContainer.classList.add('hidden');
}

// Use shared retry preview function from add-model-modal.html

// Handle form submission
document.getElementById('edit-model-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = {};
  
  // Convert form data to object
  for (let [key, value] of formData.entries()) {
    data[key] = value;
  }
  
  // Convert boolean values
  data.active = document.getElementById('edit-model-active').checked;
  
  const modelId = data.id;
  delete data.id; // Remove from payload
  
  try {
    const response = await fetch(`/api/models/${modelId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to update model');
    }
    
    // Success - close modal and reload models
    closeEditModelModal();
    loadModels();
    
  } catch (error) {
    console.error('Failed to update model:', error);
    showEditModelError(error.message);
  }
});
</script>