<!-- Add Model Modal -->
<div id="add-model-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-out" role="dialog" aria-modal="true" aria-labelledby="add-model-title" aria-describedby="add-model-description">
  <!-- Modal Container -->
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[85vh] overflow-y-auto transform transition-all duration-300 ease-out scale-95 opacity-0" id="add-model-container">
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 id="add-model-title" class="text-lg font-bold text-gray-900">Add New Model</h2>
      <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg p-1" onclick="closeAddModelModal()" aria-label="Close modal">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-4" id="add-model-description">
      <form id="add-model-form">
        <!-- 2-Column Layout Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Left Column: Basic Model Information -->
          <div class="space-y-4">
            <div>
              <h3 class="text-lg font-medium text-gray-900 mb-4 pb-2 border-b border-gray-200">Basic Information</h3>
              
              <!-- Model Name -->
              <div class="mb-3">
                <label for="add-model-name" class="block text-sm font-medium text-gray-700 mb-1">Model Name <span class="text-red-500">*</span></label>
                <input type="text" id="add-model-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="Enter model name">
              </div>

              <!-- Model Description -->
              <div class="mb-3">
                <label for="add-model-description-field" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="add-model-description-field" name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="Enter model description"></textarea>
              </div>

              <!-- Provider -->
              <div class="mb-4">
                <label for="add-model-provider" class="block text-sm font-medium text-gray-700 mb-1">Provider <span class="text-red-500">*</span></label>
                <select id="add-model-provider" name="provider" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                  <option value="">Select provider</option>
                  <option value="openai">OpenAI</option>
                  <!-- <option value="anthropic">Anthropic</option>
                  <option value="google">Google</option>
                  <option value="azure">Azure OpenAI</option>
                  <option value="aws">AWS Bedrock</option>
                  <option value="huggingface">Hugging Face</option> -->
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>

            <!-- Organization Access -->
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-2">Organization Access</h4>
              <div class="border border-gray-300 rounded-lg p-3 max-h-36 overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-sm text-gray-600">Select organizations that can access this model</span>
                  <div class="flex space-x-2">
                    <button type="button" onclick="selectAllOrgs()" class="text-xs text-blue-600 hover:text-blue-800">Select All</button>
                    <button type="button" onclick="deselectAllOrgs()" class="text-xs text-gray-600 hover:text-gray-800">Deselect All</button>
                  </div>
                </div>
                <div id="add-model-orgs-list" class="space-y-2">
                  <!-- Organizations will be populated here -->
                </div>
              </div>
            </div>

            <!-- Active Status -->
            <div>
              <label class="flex items-center">
                <input type="checkbox" id="add-model-active" name="active" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-700">Active (enable this model for use)</span>
              </label>
            </div>
          </div>

          <!-- Right Column: Configuration & Settings -->
          <div class="space-y-4">
            <div>
              <h3 class="text-base font-medium text-gray-900 mb-3 pb-2 border-b border-gray-200">Configuration</h3>
              
              <!-- API Configuration -->
              <div class="space-y-3 mb-4">
                <!-- API Endpoint -->
                <div>
                  <label for="add-model-endpoint" class="block text-sm font-medium text-gray-600 mb-1">API Endpoint</label>
                  <input type="url" id="add-model-endpoint" name="api_endpoint" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="https://api.example.com/v1">
                </div>

                <!-- API Token -->
                <div>
                  <label for="add-model-token" class="block text-sm font-medium text-gray-600 mb-1">API Token</label>
                  <input type="password" id="add-model-token" name="api_token" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="your-api-token">
                </div>

                <!-- Model ID -->
                <div>
                  <label for="add-model-id" class="block text-sm font-medium text-gray-600 mb-1">Model ID</label>
                  <input type="text" id="add-model-id" name="model_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="gpt-4">
                </div>
              </div>

              <!-- Cost Configuration -->
              <div class="space-y-3 mb-4">
                <h4 class="text-sm font-medium text-gray-700">Cost Configuration</h4>
                
                <!-- Input Cost per 1M tokens -->
                <div>
                  <label for="add-model-input-cost" class="block text-sm font-medium text-gray-600 mb-1">
                    Input Cost per 1M Tokens (USD)
                  </label>
                  <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">$</span>
                    <input type="number" id="add-model-input-cost" name="input_cost_per_1m"
                           step="0.01" min="0" max="1000000"
                           class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                           placeholder="15.00">
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Cost for 1 million input/prompt tokens</p>
                </div>

                <!-- Output Cost per 1M tokens -->
                <div>
                  <label for="add-model-output-cost" class="block text-sm font-medium text-gray-600 mb-1">
                    Output Cost per 1M Tokens (USD)
                  </label>
                  <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">$</span>
                    <input type="number" id="add-model-output-cost" name="output_cost_per_1m"
                           step="0.01" min="0" max="1000000"
                           class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                           placeholder="75.00">
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Cost for 1 million output/completion tokens</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Settings - Full Width Section -->
        <div class="mt-6 pt-4 border-t border-gray-200">
          <button type="button" onclick="toggleAdvancedSettings()" class="flex items-center text-sm font-medium text-gray-700 hover:text-gray-900">
            <svg id="advanced-chevron" class="w-4 h-4 mr-2 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            Advanced Settings
          </button>
          <div id="advanced-settings" class="hidden mt-3 space-y-4">
            <!-- Rate Limiting and Headers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <!-- Rate Limiting -->
              <div>
                <label for="add-model-rate-limit" class="block text-sm font-medium text-gray-600 mb-1">Rate Limit (requests/minute)</label>
                <input type="number" id="add-model-rate-limit" name="rate_limit" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="100">
              </div>

              <!-- Custom Headers -->
              <div>
                <label for="add-model-headers" class="block text-sm font-medium text-gray-600 mb-1">Custom Headers (JSON)</label>
                <textarea id="add-model-headers" name="headers" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder='{"Authorization": "Bearer token"}'></textarea>
              </div>
            </div>

            <!-- Retry & Timeout Configuration -->
            <div class="border-t border-gray-200 pt-3">
              <h5 class="text-sm font-medium text-gray-700 mb-3">Reliability Configuration</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Max Retries -->
                <div>
                  <label for="add-model-max-retries" class="block text-xs font-medium text-gray-600 mb-1">
                    Max Retries <span class="text-gray-400 font-normal">(Default: 2)</span>
                  </label>
                  <input type="number" id="add-model-max-retries" name="max_retries" min="0" max="3"
                         class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="2" onchange="updateRetryPreview('add')">
                  <p class="text-xs text-gray-500 mt-0.5">Retry attempts (0-3)</p>
                </div>

                <!-- Timeout -->
                <div>
                  <label for="add-model-timeout-seconds" class="block text-xs font-medium text-gray-600 mb-1">
                    Timeout (sec) <span class="text-gray-400 font-normal">(Default: 30)</span>
                  </label>
                  <input type="number" id="add-model-timeout-seconds" name="timeout_seconds" min="5" max="300"
                         class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="30">
                  <p class="text-xs text-gray-500 mt-0.5">Timeout (5-300s)</p>
                </div>

                <!-- Retry Delay -->
                <div>
                  <label for="add-model-retry-delay" class="block text-xs font-medium text-gray-600 mb-1">
                    Retry Delay (ms) <span class="text-gray-400 font-normal">(Default: 1000)</span>
                  </label>
                  <input type="number" id="add-model-retry-delay" name="retry_delay_ms" min="100" max="10000" step="100"
                         class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="1000" onchange="updateRetryPreview('add')">
                  <p class="text-xs text-gray-500 mt-0.5">Initial delay (100-10000ms)</p>
                </div>

                <!-- Backoff Multiplier -->
                <div>
                  <label for="add-model-backoff-multiplier" class="block text-xs font-medium text-gray-600 mb-1">
                    Backoff Multiplier <span class="text-gray-400 font-normal">(Default: 2.0)</span>
                  </label>
                  <input type="number" id="add-model-backoff-multiplier" name="backoff_multiplier" min="1.0" max="5.0" step="0.1"
                         class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                         placeholder="2.0" onchange="updateRetryPreview('add')">
                  <p class="text-xs text-gray-500 mt-0.5">Multiplier (1.0-5.0)</p>
                </div>
              </div>

              <!-- Retry Strategy Preview -->
              <div class="mt-3 p-2 bg-gray-50 rounded-lg">
                <h6 class="text-xs font-medium text-gray-700 mb-1">Retry Strategy Preview:</h6>
                <div id="add-retry-preview" class="text-xs text-gray-600">
                  Attempt 1: 0ms → Attempt 2: 1000ms → Attempt 3: 2000ms
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Message Container -->
        <div id="add-model-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-600" id="add-model-error-message"></p>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-end space-x-3 p-4 border-t border-gray-200">
      <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="closeAddModelModal()">Cancel</button>
      <button type="submit" form="add-model-form" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Add Model</button>
    </div>
  </div>
</div>

<script>
// Add model modal functionality
let addModelLastFocusedElement = null;
let addModelFocusableElements = [];
let availableOrganizations = [];

function openAddModelModal() {
  // Store the currently focused element
  addModelLastFocusedElement = document.activeElement;
  
  const modal = document.getElementById('add-model-modal');
  const modalContainer = document.getElementById('add-model-container');
  
  // Load organizations
  loadOrganizationsForModel();
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Trigger animations
  setTimeout(() => {
    modal.classList.add('opacity-100');
    modalContainer.classList.remove('scale-95', 'opacity-0');
    modalContainer.classList.add('scale-100', 'opacity-100');
  }, 10);
  
  // Set up focus trapping
  setupAddModelFocusTrap();
  
  // Focus the first input
  setTimeout(() => {
    document.getElementById('add-model-name').focus();
  }, 100);
  
  // Add event listeners
  document.addEventListener('keydown', handleAddModelKeyDown);
  modal.addEventListener('click', handleAddModelOverlayClick);
}

function closeAddModelModal() {
  const modal = document.getElementById('add-model-modal');
  const modalContainer = document.getElementById('add-model-container');
  
  // Trigger close animations
  modal.classList.remove('opacity-100');
  modalContainer.classList.remove('scale-100', 'opacity-100');
  modalContainer.classList.add('scale-95', 'opacity-0');
  
  // Hide modal after animation
  setTimeout(() => {
    modal.classList.add('hidden');
    
    // Reset form
    document.getElementById('add-model-form').reset();
    hideAddModelError();
    
    // Reset advanced settings
    document.getElementById('advanced-settings').classList.add('hidden');
    document.getElementById('advanced-chevron').style.transform = 'rotate(0deg)';
    
    // Restore focus
    if (addModelLastFocusedElement) {
      addModelLastFocusedElement.focus();
    }
  }, 300);
  
  // Remove event listeners
  document.removeEventListener('keydown', handleAddModelKeyDown);
  modal.removeEventListener('click', handleAddModelOverlayClick);
}

function setupAddModelFocusTrap() {
  const modal = document.getElementById('add-model-container');
  addModelFocusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
}

function handleAddModelKeyDown(event) {
  if (event.key === 'Escape') {
    closeAddModelModal();
    return;
  }
  
  if (event.key === 'Tab') {
    trapAddModelFocus(event);
  }
}

function trapAddModelFocus(event) {
  const firstFocusable = addModelFocusableElements[0];
  const lastFocusable = addModelFocusableElements[addModelFocusableElements.length - 1];
  
  if (event.shiftKey) {
    // Shift + Tab
    if (document.activeElement === firstFocusable) {
      event.preventDefault();
      lastFocusable.focus();
    }
  } else {
    // Tab
    if (document.activeElement === lastFocusable) {
      event.preventDefault();
      firstFocusable.focus();
    }
  }
}

function handleAddModelOverlayClick(event) {
  if (event.target === event.currentTarget) {
    closeAddModelModal();
  }
}

async function loadOrganizationsForModel() {
  try {
    const response = await fetch('/api/organizations', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    availableOrganizations = data.organizations || [];
    renderOrganizationsList();

  } catch (error) {
    console.error('Failed to load organizations:', error);
  }
}

function renderOrganizationsList() {
  const container = document.getElementById('add-model-orgs-list');
  
  if (availableOrganizations.length === 0) {
    container.innerHTML = '<p class="text-sm text-gray-500">No organizations available</p>';
    return;
  }
  
  container.innerHTML = availableOrganizations.map(org => `
    <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
      <input type="checkbox" name="organization_ids[]" value="${org.id}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
      <div class="ml-3 flex-1">
        <div class="text-sm font-medium text-gray-900">${org.name}</div>
        <div class="text-xs text-gray-500">ID: ${org.id}</div>
      </div>
    </label>
  `).join('');
}

function selectAllOrgs() {
  const checkboxes = document.querySelectorAll('input[name="organization_ids[]"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
}

function deselectAllOrgs() {
  const checkboxes = document.querySelectorAll('input[name="organization_ids[]"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
}

function toggleAdvancedSettings() {
  const settings = document.getElementById('advanced-settings');
  const chevron = document.getElementById('advanced-chevron');
  
  if (settings.classList.contains('hidden')) {
    settings.classList.remove('hidden');
    chevron.style.transform = 'rotate(90deg)';
  } else {
    settings.classList.add('hidden');
    chevron.style.transform = 'rotate(0deg)';
  }
}

function showAddModelError(message) {
  const errorContainer = document.getElementById('add-model-error');
  const errorMessage = document.getElementById('add-model-error-message');
  
  errorMessage.textContent = message;
  errorContainer.classList.remove('hidden');
}

function hideAddModelError() {
  const errorContainer = document.getElementById('add-model-error');
  errorContainer.classList.add('hidden');
}

// Shared retry preview function for both add and edit modals
function updateRetryPreview(prefix = 'add') {
  const maxRetries = parseInt(document.getElementById(`${prefix}-model-max-retries`).value) || 2;
  const initialDelay = parseInt(document.getElementById(`${prefix}-model-retry-delay`).value) || 1000;
  const multiplier = parseFloat(document.getElementById(`${prefix}-model-backoff-multiplier`).value) || 2.0;
  
  let preview = '';
  let delay = 0;
  
  for (let i = 1; i <= maxRetries + 1; i++) {
    if (i === 1) {
      preview += `Attempt ${i}: 0ms`;
    } else {
      delay = initialDelay * Math.pow(multiplier, i - 2);
      preview += ` → Attempt ${i}: ${Math.round(delay)}ms`;
    }
  }
  
  document.getElementById(`${prefix}-retry-preview`).textContent = preview;
}

// Initialize retry preview on page load
document.addEventListener('DOMContentLoaded', function() {
  updateRetryPreview('add');
});

// Handle form submission
document.getElementById('add-model-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = {};
  
  // Convert form data to object
  for (let [key, value] of formData.entries()) {
    if (key === 'organization_ids[]') {
      if (!data.organization_ids) data.organization_ids = [];
      data.organization_ids.push(value);
    } else {
      data[key] = value;
    }
  }
  
  // Convert boolean values
  data.active = document.getElementById('add-model-active').checked;
  
  try {
    const response = await fetch('/api/models', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to create model');
    }
    
    // Success - close modal and reload models
    closeAddModelModal();
    loadModels();
    
  } catch (error) {
    console.error('Failed to create model:', error);
    showAddModelError(error.message);
  }
});
</script>