<!-- View Key Modal -->
<div id="view-key-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-out" role="dialog" aria-modal="true" aria-labelledby="view-modal-title" aria-describedby="view-modal-description">
  <!-- Modal Container -->
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all duration-300 ease-out scale-95 opacity-0" id="view-modal-container">
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 id="view-modal-title" class="text-xl font-bold text-gray-900">API Key Details</h2>
      <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg p-1" onclick="closeViewModal()" aria-label="Close modal">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6 space-y-6" id="view-modal-description">
      <!-- Key Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">API Key Name</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-name" class="text-sm text-gray-900"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Key Type</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-type" class="text-sm text-gray-900"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Organization</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-org" class="text-sm text-gray-900"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Created By</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-user" class="text-sm text-gray-900"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Created Date</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-created" class="text-sm text-gray-900"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Max Tokens</label>
          <div class="p-3 bg-gray-50 rounded-lg">
            <span id="view-key-tokens" class="text-sm text-gray-900"></span>
          </div>
        </div>
      </div>

      <!-- API Key Display -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
        <div class="flex items-center space-x-2">
          <div class="flex-1 p-3 bg-gray-100 rounded-lg font-mono text-sm">
            <span id="view-key-value" class="text-gray-900"></span>
          </div>
          <button type="button" onclick="copyToClipboard()" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Description -->
      <div id="view-key-description-container" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <div class="p-3 bg-gray-50 rounded-lg">
          <span id="view-key-description" class="text-sm text-gray-900"></span>
        </div>
      </div>

      <!-- Status -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        <div class="p-3 bg-gray-50 rounded-lg">
          <span id="view-key-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"></span>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-between p-6 border-t border-gray-200">
      <button type="button" id="view-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" onclick="handleDeleteFromView()">
        Delete Key
      </button>
      <div class="flex items-center space-x-3">
        <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="closeViewModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// View modal functionality
let currentViewKey = null;
let viewLastFocusedElement = null;
let viewFocusableElements = [];

function openViewModal(keyData) {
  // Store the current key data
  currentViewKey = keyData;
  
  // Store the currently focused element
  viewLastFocusedElement = document.activeElement;
  
  const modal = document.getElementById('view-key-modal');
  const modalContainer = document.getElementById('view-modal-container');
  
  // Populate modal with key data
  document.getElementById('view-key-name').textContent = keyData.name || 'Unnamed Key';
  document.getElementById('view-key-type').textContent = keyData.type || 'Unknown';
  document.getElementById('view-key-org').textContent = keyData.orgName || 'Unknown';
  document.getElementById('view-key-user').textContent = keyData.userEmail || 'Unknown';
  document.getElementById('view-key-created').textContent = keyData.createdAt || 'Unknown';
  document.getElementById('view-key-tokens').textContent = keyData.maxTokens ? keyData.maxTokens.toLocaleString() : 'Unknown';
  document.getElementById('view-key-value').textContent = keyData.key || 'Hidden';
  
  // Handle description
  const descriptionContainer = document.getElementById('view-key-description-container');
  const descriptionElement = document.getElementById('view-key-description');
  if (keyData.description && keyData.description.trim()) {
    descriptionElement.textContent = keyData.description;
    descriptionContainer.classList.remove('hidden');
  } else {
    descriptionContainer.classList.add('hidden');
  }
  
  // Handle status
  const statusElement = document.getElementById('view-key-status');
  if (keyData.active) {
    statusElement.textContent = 'Active';
    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
  } else {
    statusElement.textContent = 'Inactive';
    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
  }
  
  // Handle delete button state
  const deleteBtn = document.getElementById('view-delete-btn');
  const shouldDisable = shouldDisableDelete(keyData);
  deleteBtn.disabled = shouldDisable;
  
  if (shouldDisable) {
    deleteBtn.title = 'Cannot delete this key';
    deleteBtn.className = 'px-4 py-2 text-sm font-medium text-gray-400 bg-gray-200 cursor-not-allowed rounded-lg transition-colors duration-200';
  } else {
    deleteBtn.title = 'Delete this API key';
    deleteBtn.className = 'px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2';
  }
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Trigger animations
  setTimeout(() => {
    modal.classList.add('opacity-100');
    modalContainer.classList.remove('scale-95', 'opacity-0');
    modalContainer.classList.add('scale-100', 'opacity-100');
  }, 10);
  
  // Set up focus trapping
  setupViewFocusTrap();
  
  // Focus the close button
  setTimeout(() => {
    modal.querySelector('button[onclick="closeViewModal()"]').focus();
  }, 100);
  
  // Add event listeners
  document.addEventListener('keydown', handleViewKeyDown);
  modal.addEventListener('click', handleViewOverlayClick);
}

function closeViewModal() {
  const modal = document.getElementById('view-key-modal');
  const modalContainer = document.getElementById('view-modal-container');
  
  // Trigger close animations
  modal.classList.remove('opacity-100');
  modalContainer.classList.remove('scale-100', 'opacity-100');
  modalContainer.classList.add('scale-95', 'opacity-0');
  
  // Hide modal after animation
  setTimeout(() => {
    modal.classList.add('hidden');
    
    // Reset state
    currentViewKey = null;
    
    // Restore focus
    if (viewLastFocusedElement) {
      viewLastFocusedElement.focus();
    }
  }, 300);
  
  // Remove event listeners
  document.removeEventListener('keydown', handleViewKeyDown);
  modal.removeEventListener('click', handleViewOverlayClick);
}

function setupViewFocusTrap() {
  const modal = document.getElementById('view-modal-container');
  viewFocusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
}

function handleViewKeyDown(event) {
  if (event.key === 'Escape') {
    closeViewModal();
    return;
  }
  
  if (event.key === 'Tab') {
    trapViewFocus(event);
  }
}

function trapViewFocus(event) {
  const firstFocusable = viewFocusableElements[0];
  const lastFocusable = viewFocusableElements[viewFocusableElements.length - 1];
  
  if (event.shiftKey) {
    // Shift + Tab
    if (document.activeElement === firstFocusable) {
      event.preventDefault();
      lastFocusable.focus();
    }
  } else {
    // Tab
    if (document.activeElement === lastFocusable) {
      event.preventDefault();
      firstFocusable.focus();
    }
  }
}

function handleViewOverlayClick(event) {
  if (event.target === event.currentTarget) {
    closeViewModal();
  }
}

function handleDeleteFromView() {
  if (!currentViewKey) return;
  
  // Close view modal first
  closeViewModal();
  
  // Open delete confirmation modal
  setTimeout(() => {
    openDeleteModal(currentViewKey.id, currentViewKey.name || currentViewKey.key);
  }, 350);
}

function copyToClipboard() {
  const keyValue = document.getElementById('view-key-value').textContent;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(keyValue).then(() => {
      // Show temporary feedback
      const button = event.target.closest('button');
      const originalHTML = button.innerHTML;
      button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
      button.classList.add('text-green-600');
      
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('text-green-600');
      }, 2000);
    }).catch(() => {
      // Fallback for older browsers
      fallbackCopyToClipboard(keyValue);
    });
  } else {
    // Fallback for older browsers
    fallbackCopyToClipboard(keyValue);
  }
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
    // Show feedback
    alert('API key copied to clipboard!');
  } catch (err) {
    console.error('Failed to copy: ', err);
    alert('Failed to copy to clipboard');
  }
  
  document.body.removeChild(textArea);
}
</script>