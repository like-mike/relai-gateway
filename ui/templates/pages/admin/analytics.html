<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usage Analytics - RelAI Gateway</title>
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="/theme.css" rel="stylesheet">
</head>
<body class="h-full text-gray-900">
  <!-- Banner/Header -->
  {{template "banner.html" .}}

  <!-- Main layout -->
  <div class="flex h-screen">
    <!-- Sidebar -->
    {{template "sidebar.html" .}}

    <!-- Main Content -->
    <main class="flex-1 p-10 space-y-6 overflow-auto">
      <!-- Page Header -->
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Usage Analytics</h1>
          <p class="text-gray-600 mt-1">Monitor API usage, costs, and performance metrics</p>
        </div>
        <div class="flex items-center space-x-4">
          <button id="refreshBtn" onclick="refreshDashboard()" class="bg-blue-600 text-white px-4 py-2 text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex flex-wrap items-center gap-4">
          <!-- Time Range Selector -->
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Time Range:</label>
            <select id="timeRangeSelect" onchange="updateTimeRange()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="6h">Last 6 Hours</option>
              <option value="12h">Last 12 Hours</option>
              <option value="24h">Last 24 Hours</option>
              <option value="7d" selected>Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>

          <!-- Organization Toggle -->
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">View:</label>
            <label class="flex items-center">
              <input type="checkbox" id="globalToggle" checked onchange="toggleGlobalView()" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <span class="ml-2 text-sm text-gray-700">Global View</span>
            </label>
          </div>

          <!-- Organization Selector -->
          <div id="orgSelectorContainer" class="hidden flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Organization:</label>
            <select id="orgSelect" onchange="updateOrganization()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <!-- Populated by JavaScript -->
            </select>
          </div>

          <!-- Last Updated -->
          <div class="text-sm text-gray-500">
            Last updated: <span id="lastUpdated">-</span>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
            <span class="text-gray-600">Loading analytics data...</span>
          </div>
        </div>
      </div>

      <!-- Metrics Cards -->
      <div id="metricsSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"></path>
                </svg>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Total Requests</p>
              <p class="text-2xl font-semibold text-gray-900" id="totalRequests">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Success Rate</p>
              <p class="text-2xl font-semibold text-gray-900" id="successRate">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Failed Requests</p>
              <p class="text-2xl font-semibold text-gray-900" id="failedRequests">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Total Tokens</p>
              <p class="text-2xl font-semibold text-gray-900" id="totalTokens">-</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Avg Cost/Request</p>
              <p class="text-2xl font-semibold text-gray-900" id="avgCostPerRequest">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Cost Trend Chart -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 id="chartTitle" class="text-lg font-semibold text-gray-900">Cost Trend</h3>
          <div class="text-sm text-gray-500">
            Total: <span id="totalCost" class="font-semibold text-gray-900">-</span>
          </div>
        </div>
        <div class="h-80">
          <canvas id="costTrendChart"></canvas>
        </div>
      </div>

      <!-- Top Lists -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Top Models -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Models by Spend</h3>
          <div id="topModelsList" class="space-y-3">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Top API Keys -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Top API Keys by Spend</h3>
          <div id="topAPIKeysList" class="space-y-3">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Provider Spend -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Spend by Provider</h3>
          <div id="providerSpendList" class="space-y-3">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Analytics Dashboard Controller
    class AnalyticsDashboard {
      constructor() {
        this.timeRange = '7d';
        this.orgID = '';
        this.chart = null;
        this.refreshInterval = null;
        this.init();
      }

      async init() {
        await this.loadOrganizations();
        await this.loadDashboard();
        this.startAutoRefresh();
      }

      async loadOrganizations() {
        try {
          const response = await fetch('/api/organizations');
          const data = await response.json();
          const select = document.getElementById('orgSelect');
          
          select.innerHTML = '<option value="">Select organization...</option>';
          data.organizations.forEach(org => {
            const option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Failed to load organizations:', error);
        }
      }

      async loadDashboard() {
        this.showLoading(true);
        
        try {
          const params = new URLSearchParams({
            range: this.timeRange,
            org_id: this.orgID
          });
          
          const response = await fetch(`/api/analytics/dashboard?${params}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          this.updateMetrics(data.metrics);
          this.updateChart(data.daily_costs);
          this.updateTopLists(data);
          this.updateLastUpdated();
          
        } catch (error) {
          console.error('Failed to load dashboard:', error);
          this.showError('Failed to load analytics data');
        } finally {
          this.showLoading(false);
        }
      }

      updateMetrics(metrics) {
        document.getElementById('totalRequests').textContent = this.formatNumber(metrics.total_requests);
        document.getElementById('successRate').textContent = metrics.success_rate.toFixed(1) + '%';
        document.getElementById('failedRequests').textContent = this.formatNumber(metrics.failed_requests);
        document.getElementById('totalTokens').textContent = this.formatNumber(metrics.total_tokens);
        document.getElementById('avgCostPerRequest').textContent = '$' + metrics.avg_cost_per_request.toFixed(4);
        document.getElementById('totalCost').textContent = '$' + metrics.total_cost.toFixed(2);
      }

      updateChart(dailyCosts) {
        const ctx = document.getElementById('costTrendChart').getContext('2d');
        
        if (this.chart) {
          this.chart.destroy();
        }

        // Update chart title based on time range
        const chartTitle = document.getElementById('chartTitle');
        const isHourly = ['6h', '12h', '24h'].includes(this.timeRange);
        chartTitle.textContent = isHourly ? 'Hourly Cost Trend' : 'Daily Cost Trend';
        
        // Format labels based on time range
        const labels = dailyCosts.map(d => {
          const date = new Date(d.date);
          if (isHourly) {
            // For hourly data, show hour format
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } else {
            // For daily data, show date format
            return date.toLocaleDateString();
          }
        });
        
        this.chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: isHourly ? 'Hourly Cost' : 'Daily Cost',
              data: dailyCosts.map(d => d.cost),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(2);
                  }
                }
              },
              x: {
                ticks: {
                  maxTicksLimit: isHourly ? 12 : 7, // Limit ticks for readability
                  maxRotation: 45
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(tooltipItems) {
                    const index = tooltipItems[0].dataIndex;
                    const originalDate = dailyCosts[index].date;
                    const date = new Date(originalDate);
                    
                    if (isHourly) {
                      return date.toLocaleString();
                    } else {
                      return date.toLocaleDateString();
                    }
                  },
                  label: function(context) {
                    const cost = context.parsed.y;
                    const index = context.dataIndex;
                    const requests = dailyCosts[index].request_count;
                    return [
                      `Cost: $${cost.toFixed(2)}`,
                      `Requests: ${requests}`
                    ];
                  }
                }
              }
            }
          }
        });
      }

      updateTopLists(data) {
        // Update top models
        const modelsList = document.getElementById('topModelsList');
        if (data.top_models && data.top_models.length > 0) {
          modelsList.innerHTML = data.top_models.slice(0, 5).map((model, index) => `
            <div class="flex items-center justify-between py-2">
              <div class="flex items-center">
                <span class="text-sm font-medium text-gray-500 w-4">${index + 1}.</span>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">${model.name}</p>
                  <p class="text-xs text-gray-500">${this.formatNumber(model.request_count)} requests</p>
                </div>
              </div>
              <span class="text-sm font-semibold text-gray-900">$${model.total_cost.toFixed(2)}</span>
            </div>
          `).join('');
        } else {
          modelsList.innerHTML = '<p class="text-sm text-gray-500">No data available</p>';
        }

        // Update top API keys
        const keysList = document.getElementById('topAPIKeysList');
        if (data.top_api_keys && data.top_api_keys.length > 0) {
          keysList.innerHTML = data.top_api_keys.slice(0, 5).map((key, index) => `
            <div class="flex items-center justify-between py-2">
              <div class="flex items-center">
                <span class="text-sm font-medium text-gray-500 w-4">${index + 1}.</span>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">${key.name}</p>
                  <p class="text-xs text-gray-500 font-mono">${key.key_prefix}</p>
                </div>
              </div>
              <span class="text-sm font-semibold text-gray-900">$${key.total_cost.toFixed(2)}</span>
            </div>
          `).join('');
        } else {
          keysList.innerHTML = '<p class="text-sm text-gray-500">No data available</p>';
        }

        // Update provider spend
        const providerList = document.getElementById('providerSpendList');
        if (data.provider_spend && data.provider_spend.length > 0) {
          providerList.innerHTML = data.provider_spend.map(provider => `
            <div class="flex items-center justify-between py-2">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-blue-500 mr-3"></div>
                <div>
                  <p class="text-sm font-medium text-gray-900">${provider.provider}</p>
                  <p class="text-xs text-gray-500">${this.formatNumber(provider.request_count)} requests</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-semibold text-gray-900">$${provider.total_cost.toFixed(2)}</p>
                <p class="text-xs text-gray-500">${provider.percentage.toFixed(1)}%</p>
              </div>
            </div>
          `).join('');
        } else {
          providerList.innerHTML = '<p class="text-sm text-gray-500">No data available</p>';
        }
      }

      updateLastUpdated() {
        const now = new Date();
        document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
      }

      formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
      }

      showLoading(show) {
        const loading = document.getElementById('loadingState');
        const content = document.getElementById('metricsSection');
        
        if (show) {
          loading.classList.remove('hidden');
          content.style.opacity = '0.5';
        } else {
          loading.classList.add('hidden');
          content.style.opacity = '1';
        }
      }

      showError(message) {
        // TODO: Implement error display
        console.error(message);
      }

      startAutoRefresh() {
        // Auto-refresh every 5 minutes
        this.refreshInterval = setInterval(() => {
          this.loadDashboard();
        }, 5 * 60 * 1000);
      }

      stopAutoRefresh() {
        if (this.refreshInterval) {
          clearInterval(this.refreshInterval);
          this.refreshInterval = null;
        }
      }
    }

    // Global functions
    let dashboard;

    document.addEventListener('DOMContentLoaded', function() {
      dashboard = new AnalyticsDashboard();
    });

    function updateTimeRange() {
      const select = document.getElementById('timeRangeSelect');
      dashboard.timeRange = select.value;
      dashboard.loadDashboard();
    }

    function toggleGlobalView() {
      const toggle = document.getElementById('globalToggle');
      const orgContainer = document.getElementById('orgSelectorContainer');
      
      if (toggle.checked) {
        // Global view
        dashboard.orgID = '';
        orgContainer.classList.add('hidden');
      } else {
        // Organization view
        orgContainer.classList.remove('hidden');
      }
      
      dashboard.loadDashboard();
    }

    function updateOrganization() {
      const select = document.getElementById('orgSelect');
      dashboard.orgID = select.value;
      dashboard.loadDashboard();
    }

    function refreshDashboard() {
      dashboard.loadDashboard();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (dashboard) {
        dashboard.stopAutoRefresh();
      }
    });
  </script>
</body>
</html>