version: '3.8'

x-relai-base: &relai-base
  build:
    context: .
    dockerfile: Dockerfile
  env_file:
    - .env
  command: ./relai-gateway
  environment:
    - USE_DUMMY_BACKEND=1
  depends_on:
    - dummy-backend

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./data/prometheus:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
    depends_on:
      - prometheus

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    ports:
      - "4317:4317"
      - "4318:4318"
      - "55681:55681"
    volumes:
      - ./otel-collector-config.yml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - jaeger

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "14250:14250"

  nginx:
    image: nginx:alpine
    container_name: relai-gateway-lb
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - relai1
      - relai2
      # - relai3
      # - relai4

  relai1:
    <<: *relai-base
    container_name: relai-gateway-1

  relai2:
    <<: *relai-base
    container_name: relai-gateway-2

  # relai3:
  #   <<: *relai-base
  #   container_name: relai-gateway-3

  # relai4:
  #   <<: *relai-base
  #   container_name: relai-gateway-4

  dummy-backend:
    build:
      context: loadtest
      dockerfile: Dockerfile
    container_name: dummy-backend
